{% extends 'base.html' %}
{% load review_tags %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Reviews</h2>
    
    <!-- Review Form (hidden by default, shown with HTMX) -->
    <div id="review-form-container" class="mb-4"></div>
    
    <!-- Leave Review Button (shown if user can review and not currently creating) -->
    {% if not user_review and request.user|can_review and not is_creating_review %}
    <button class="btn btn-primary mb-4"
            hx-get="{% url 'reviews:create' %}"
            hx-target="#review-form-container"
            hx-swap="innerHTML"
            hx-trigger="click"
            hx-headers='{"HX-Target": "review-form-container"}'>
        Leave a Review
    </button>
    {% endif %}

    <!-- Reviews List -->
    <div id="reviews-list" hx-trigger="load, reviewUpdated from:body">
        {% include 'reviews/partials/review_list.html' %}
    </div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hide leave review button when form is shown
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'review-form-container') {
            const leaveReviewBtn = document.querySelector('[hx-get="{% url 'reviews:create' %}"]');
            if (leaveReviewBtn) {
                leaveReviewBtn.style.display = 'none';
            }
        }
    });

    // Show leave review button when form is cancelled
    document.body.addEventListener('reviewFormCancelled', function() {
        const leaveReviewBtn = document.querySelector('[hx-get="{% url 'reviews:create' %}"]');
        if (leaveReviewBtn && !document.getElementById('review-form-container').innerHTML) {
            leaveReviewBtn.style.display = 'block';
        }
    });
});
</script>
{% endblock %}